<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>


    <meta name="description" content="重新发现、定义并创造这个世界..." />



  <meta name="keywords" content="Hexo,next" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description" content="一个由Square构建的‘OK’框架，将构建一套有效的Android架构开发。
背景2015年4月9日Android界的大神Jake Wharton参加Droidcon MTL 2015大会，在会议上他向Andorid开发者展示了Square公司的一套成熟架构，这套架构他们开源并完善了3年多，演讲的主题也便是我们今天要讨论的核心问题：A Few ‘Ok’ Libraries in Square。">
<meta property="og:type" content="article">
<meta property="og:title" content="【正谈10月】Square技术架构">
<meta property="og:url" content="http://yoursite.com/2015/10/19/ZT10_3_S/index.html">
<meta property="og:site_name" content="sabria">
<meta property="og:description" content="一个由Square构建的‘OK’框架，将构建一套有效的Android架构开发。
背景2015年4月9日Android界的大神Jake Wharton参加Droidcon MTL 2015大会，在会议上他向Andorid开发者展示了Square公司的一套成熟架构，这套架构他们开源并完善了3年多，演讲的主题也便是我们今天要讨论的核心问题：A Few ‘Ok’ Libraries in Square。">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/Image%201111113.png">
<meta property="og:image" content="http://i.imgur.com/C3G1yXh.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqq5.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqq6.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqq7.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqqq8.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443Image2222%201.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443QQQImage%202.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443qqqqImage%205.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443zzzzmage%209.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443aaaaImage%207.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443aaaaImage%206.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443啊啊啊啊Image%208.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443额Image%2010.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443tttttImage%2012.png">
<meta property="og:image" content="http://7xn9yd.com1.z0.glb.clouddn.com/736443ttttttImage%2011.png">
<meta property="og:updated_time" content="2015-10-19T16:28:15.744Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【正谈10月】Square技术架构">
<meta name="twitter:description" content="一个由Square构建的‘OK’框架，将构建一套有效的Android架构开发。
背景2015年4月9日Android界的大神Jake Wharton参加Droidcon MTL 2015大会，在会议上他向Andorid开发者展示了Square公司的一套成熟架构，这套架构他们开源并完善了3年多，演讲的主题也便是我们今天要讨论的核心问题：A Few ‘Ok’ Libraries in Square。">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide'
  };
</script>

    <title> 【正谈10月】Square技术架构 // sabria </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->




<div class="container one-column page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">sabria</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
    </ul>
  

  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              【正谈10月】Square技术架构
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-10-19T22:45:48+08:00" content="2015-10-19">
            2015-10-19
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>一个由Square构建的‘OK’框架，将构建一套有效的Android架构开发。</p>
<h2 id="背景">背景</h2><p>2015年4月9日Android界的大神Jake Wharton参加Droidcon MTL 2015大会，在会议上他向Andorid开发者展示了Square公司的一套成熟架构，这套架构他们开源并完善了3年多，演讲的主题也便是我们今天要讨论的核心问题：A Few ‘Ok’ Libraries in Square。</p>
<p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/Image%201111113.png" alt=""><br>(话说J神在Square的伙食是不是越来越好了？呵呵{笑脸}…)</p>
<h2 id="A_Few_‘Ok’_Libraries_in_Square">A Few ‘Ok’ Libraries in Square</h2><p><img src="http://i.imgur.com/C3G1yXh.png" alt=""></p>
<blockquote>
<p>*金字塔塔底由Okio替代并延伸java-io;</p>
<p>*网络数据请求层由Okhttp取代HttpClient和HttpURLConnection;</p>
<p>*Json数据转换层由Moshi替代原生json解析;</p>
<p>*表层代码调用层由Retrofit实现REST-API列表。</p>
</blockquote>
<p>This talk will be an in-depth look at Okio—a tiny library for interacting with bytes—and a few of the libraries written on top of it: OkHttp, Retrofit, and a newcomer named Moshi.</p>
<p>Okio evolved naturally inside of OkHttp before being split out into its own library. It wraps common patterns behind a friendly API for reading, writing, and processing data. We’ll start with some fundamentals of the library and how it can enable you to work very close to raw data with ease.</p>
<p>After an introduction to Okio, we will look at three libraries written with it: OkHttp, a modern HTTP client; Retrofit, a high-level HTTP wrapper; and Moshi, a brand new library for serialization.</p>
<p>Not only are these libraries powerful on their own, but when combined their efficiency and performance dramatically increase. We’ll conclude with demonstration of how to use them in your applications to great effect.</p>
<p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqq5.png" alt=""></p>
<p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqq6.png" alt=""></p>
<p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqq7.png" alt=""></p>
<p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/Image%20qqqqqqq8.png" alt=""></p>
<h3 id="一-Okio">一.Okio</h3><p>Okio is a new library that complements java.io and java.nio to make it much easier to access, store, and process your data.</p>
<p><a href="https://github.com/square/okio" title="https://github.com/square/okio" target="_blank" rel="external">https://github.com/square/okio</a></p>
<p>Okio是一个对原有的java.io和java.nio进行改进的IO库，使IO操作更加高效和方便。  </p>
<p>1.对数据进行了分块处理，对大数据效率尤为明显;</p>
<p>2.对数据块使用链表进行管理;</p>
<p>3.对闲置的块进行管理，通过一个块池（SegmentPool）的管理，避免系统GC和申请byte时的zero-fill。</p>
<p>4.它对数据的读取写入进行了封装;</p>
<p>5.超时操作;</p>
<h2 id="ByteStrings_and_Buffers">ByteStrings and Buffers</h2><p>Okio is built around two types that pack a lot of capability into a straightforward API:</p>
<ul>
<li>[<strong>ByteString</strong>][3] is an immutable sequence of bytes. For character data, <code>String</code><br>is fundamental. <code>ByteString</code> is String’s long-lost brother, making it easy to<br>treat binary data as a value. This class is ergonomic: it knows how to encode<br>and decode itself as hex, base64, and UTF-8.</li>
</ul>
<p>ByteString是一个固定大小的byte序列（由一个byte数组构成）。String是Java经常使用到的一个基本类型，ByteString对String进行了封装，为byte和String间的转换和String不同值间的转换（UTF-8编解码，Hex编解码，Base64编解码，ASCIll编解码）提供了十分方便的操作。</p>
<ul>
<li>[<strong>Buffer</strong>][4] is a mutable sequence of bytes. Like <code>ArrayList</code>, you don’t need<br>to size your buffer in advance. You read and write buffers as a queue: write<br>data to the end and read it from the front. There’s no obligation to manage<br>positions, limits, or capacities.</li>
</ul>
<p>Buffer是一个不固定大小的byte序列（由一个节点为Segment的双向循环队列链表构成），它充当Sink、Source、InputStream和OutputStream间的高效缓存区，由于Buffer实现了BufferedSource和BufferedSink这两个接口，所以可以很方便的对其进行IO操作。Buffer在多线程编程里很有用，比如一个负责网络的线程可以通过这种方式和工作线程进行数据交换，但是又不发生数据的复制。</p>
<h2 id="Sources_and_Sinks">Sources and Sinks</h2><p>Okio的流类型：<br>Okio includes its own stream types called Source and Sink that work like InputStream and OutputStream。</p>
<ul>
<li><p>接口[<strong>Sink</strong>]，[<strong>BufferedSink</strong>]<br>Sink和java.io中的OutputStream类似，BufferedSink是一个对Sink进行扩展的接口。使用OutputStream时，在传输不同的数据是需要对OutputStream进行不同的包装，比如用DataOutputStream进行原始数据的IO，用BufferedOutputStream进行带缓存的数据IO，用OutputStreamWriter进行字符编码。对于Sink来说，只需要使用BufferedSink就可以实现以上所有的情况。</p>
</li>
<li><p>接口[<strong>Source</strong>]，[<strong>BufferedSource</strong>]<br>Source和java.io中的InputStream类似，BufferedSource是一个对Source进行扩展的接口。使用InputStream时，在传输不同的数据是需要对InputStream进行不同的包装，比如用DataInputStream进行原始数据的IO，用BufferedInputStream进行带缓存的数据IO，用OutputStreamReader进行字符编码。对于Source来说，只需要使用BufferedSource就可以实现以上所有的情况。</p>
</li>
</ul>
<p>Sources and sinks interoperate with InputStream and OutputStream. You can view any Source as an InputStream, and you can view any InputStream as a Source. Similarly for Sink and OutputStream.</p>
<h2 id="API：">API：</h2><p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443Image2222%201.png" alt=""></p>
<p>首先来看如何获取Source、Sink和Buffer、ByteString对象</p>
<p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443QQQImage%202.png" alt=""></p>
<pre><code><span class="comment">//Source和java.io中的InputStream类似</span>
<span class="keyword">Source</span> <span class="keyword">source</span> = Okio.<span class="keyword">source</span>(InputStream)；
</code></pre><p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443qqqqImage%205.png" alt=""></p>
<pre><code><span class="comment">//BufferedSource是一个对Source进行扩展的接口。</span>
BufferedSource pngSource = Okio.buffer(Okio.<span class="keyword">source</span>(<span class="keyword">in</span>));
</code></pre><p><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443zzzzmage%209.png" alt=""><br><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443aaaaImage%207.png" alt=""><br><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443aaaaImage%206.png" alt=""><br><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443啊啊啊啊Image%208.png" alt=""></p>
<pre><code><span class="comment">// Each chunk is a length, type, data, and CRC offset.</span>
<span class="keyword">int</span> <span class="built_in">length</span> = pngSource.readInt();
String type = pngSource.readUtf8(<span class="number">4</span>);
pngSource.readFully(chunk, <span class="built_in">length</span>);
<span class="keyword">int</span> crc = pngSource.readInt();
</code></pre><p>一般获取Buffer及读取UTF-8字符串文件再获取为inputStream：<br><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443额Image%2010.png" alt=""><br><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443tttttImage%2012.png" alt=""><br><img src="http://7xn9yd.com1.z0.glb.clouddn.com/736443ttttttImage%2011.png" alt=""></p>
<pre><code>SSLSocketFactory sslSocketFactory = SSLUtil.getSSLSocketFactory<span class="params">(new Buffer<span class="params">()</span>.writeUtf8<span class="params">(CERT)</span>.inputStream<span class="params">()</span>)</span>;
client.setSslSocketFactory<span class="params">(sslSocketFactory)</span>;
</code></pre><h2 id="OKIO使用：">OKIO使用：</h2><p>根据PNG文件署名域判断一个图片是否是真实PNG：</p>
<pre><code><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ByteString PNG_HEADER=ByteString.decodeHex(<span class="string">"89504e470d0a1a0a"</span>);

<span class="keyword">public</span> <span class="keyword">boolean</span> isPng(InputStream in) <span class="keyword">throws</span> IOException {
  BufferedSource pngSource = Okio.buffer(Okio.<span class="keyword">source</span>(in));

  ByteString header = pngSource.readByteString(PNG_HEADER.<span class="keyword">size</span>());
  <span class="keyword">if</span> (!header.equals(PNG_HEADER)) {
    <span class="keyword">return</span> <span class="keyword">false</span>;
  }<span class="keyword">else</span>{
    <span class="keyword">return</span> <span class="keyword">true</span>;    
  }

}
</code></pre><h3 id="二-Okhttp">二.Okhttp</h3><h3 id="三-Moshi">三.Moshi</h3><h3 id="四-Retrofit">四.Retrofit</h3></span>
      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/10/07/ZT10_2/" rel="next">【正谈10月】框架的规范（一）</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>

            

            
              <div class="comments" id="comments">
                
              </div>
            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="熊伟xiongwei" itemprop="image"/>
          <p class="site-author-name" itemprop="name">熊伟xiongwei</p>
        </div>
        <p class="site-description motion-element" itemprop="description">重新发现、定义并创造这个世界...</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">0</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/xiaomeixw" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.sabria.net/" target="_blank">anotherblog</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/1561605537" target="_blank">weibo</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#A_Few_‘Ok’_Libraries_in_Square"><span class="nav-number">2.</span> <span class="nav-text">A Few ‘Ok’ Libraries in Square</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#一-Okio"><span class="nav-number">2.1.</span> <span class="nav-text">一.Okio</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ByteStrings_and_Buffers"><span class="nav-number">3.</span> <span class="nav-text">ByteStrings and Buffers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sources_and_Sinks"><span class="nav-number">4.</span> <span class="nav-text">Sources and Sinks</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API："><span class="nav-number">5.</span> <span class="nav-text">API：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OKIO使用："><span class="nav-number">6.</span> <span class="nav-text">OKIO使用：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#二-Okhttp"><span class="nav-number">6.1.</span> <span class="nav-text">二.Okhttp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三-Moshi"><span class="nav-number">6.2.</span> <span class="nav-text">三.Moshi</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四-Retrofit"><span class="nav-number">6.3.</span> <span class="nav-text">四.Retrofit</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">熊伟xiongwei</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>


  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.4" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>








<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
